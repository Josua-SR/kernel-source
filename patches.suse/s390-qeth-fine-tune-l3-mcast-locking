From: Julian Wiedmann <jwi@linux.ibm.com>
Date: Thu, 14 Nov 2019 11:19:19 +0100
Subject: s390/qeth: fine-tune L3 mcast locking
Git-commit: ddf28100ee1fa4fa5946dacdfe92d5c795a236e2
Patch-mainline: v5.5-rc1
References: jsc#SLE-7474

Push the inet6_dev locking down into the helper that actually needs it
for walking the mc_list.

Signed-off-by: Julian Wiedmann <jwi@linux.ibm.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Petr Tesarik <ptesarik@suse.com>
---
 drivers/s390/net/qeth_l3_main.c |    7 +++----
 1 file changed, 3 insertions(+), 4 deletions(-)

--- a/drivers/s390/net/qeth_l3_main.c
+++ b/drivers/s390/net/qeth_l3_main.c
@@ -1206,6 +1206,7 @@ static void qeth_l3_add_mc6_to_hash(stru
 	if (!tmp)
 		return;
 
+	read_lock_bh(&in6_dev->lock);
 	for (im6 = in6_dev->mc_list; im6 != NULL; im6 = im6->next) {
 		tmp->u.a6.addr = im6->mca_addr;
 		tmp->is_multicast = 1;
@@ -1228,6 +1229,8 @@ static void qeth_l3_add_mc6_to_hash(stru
 				&ipm->hnode, qeth_l3_ipaddr_hash(ipm));
 
 	}
+	read_unlock_bh(&in6_dev->lock);
+
 	kfree(tmp);
 }
 
@@ -1253,9 +1256,7 @@ static void qeth_l3_add_vlan_mc6(struct
 		in_dev = in6_dev_get(netdev);
 		if (!in_dev)
 			continue;
-		read_lock_bh(&in_dev->lock);
 		qeth_l3_add_mc6_to_hash(card, in_dev);
-		read_unlock_bh(&in_dev->lock);
 		in6_dev_put(in_dev);
 	}
 }
@@ -1273,10 +1274,8 @@ static void qeth_l3_add_multicast_ipv6(s
 		return;
 
 	rcu_read_lock();
-	read_lock_bh(&in6_dev->lock);
 	qeth_l3_add_mc6_to_hash(card, in6_dev);
 	qeth_l3_add_vlan_mc6(card);
-	read_unlock_bh(&in6_dev->lock);
 	rcu_read_unlock();
 	in6_dev_put(in6_dev);
 }
