From: Miroslav Benes <mbenes@suse.cz>
Subject: livepatch: Add -fdump-ipa-clones to build
Patch-mainline: Never, SUSE-specific
References: fate#323487

When -fdump-ipa-clones option is enabled, GCC reports about its cloning
operation during IPA optimizations. We use the information for live
patches preparation, because it is crucial to know if and how functions
are optimized.

Introduce LIVEPATCH_IPA_CLONES to allow dumping the ipa clones during our
kernel build.

Signed-off-by: Miroslav Benes <mbenes@suse.cz>
---
 Makefile                 |    6 ++++++
 kernel/livepatch/Kconfig |    8 ++++++++
 scripts/Kbuild.include   |    2 +-
 3 files changed, 15 insertions(+), 1 deletion(-)

--- a/Makefile
+++ b/Makefile
@@ -848,6 +848,12 @@ ifdef CONFIG_LIVEPATCH
 KBUILD_CFLAGS += $(call cc-option, -flive-patching=inline-clone)
 endif
 
+ifdef CONFIG_LIVEPATCH_IPA_CLONES
+ifeq ($(KBUILD_EXTMOD),)
+KBUILD_CFLAGS += -fdump-ipa-clones
+endif
+endif
+
 # arch Makefile may override CC so keep this after arch Makefile is included
 NOSTDINC_FLAGS += -nostdinc -isystem $(shell $(CC) -print-file-name=include)
 
--- a/kernel/livepatch/Kconfig
+++ b/kernel/livepatch/Kconfig
@@ -18,3 +18,11 @@ config LIVEPATCH
 	  module uses the interface provided by this option to register
 	  a patch, causing calls to patched functions to be redirected
 	  to new function code contained in the patch module.
+
+config LIVEPATCH_IPA_CLONES
+	bool "Kernel Live Patching - Dump IPA Clones"
+	depends on LIVEPATCH
+	depends on $(cc-option, -fdump-ipa-clones)
+	help
+	  Let GCC dump IPA clones during compilation.
+	  Say N if you are unsure.
--- a/scripts/Kbuild.include
+++ b/scripts/Kbuild.include
@@ -117,7 +117,7 @@ __cc-option = $(call try-run,\
 
 # Do not attempt to build with gcc plugins during cc-option tests.
 # (And this uses delayed resolution so the flags will be up to date.)
-CC_OPTION_CFLAGS = $(filter-out $(GCC_PLUGINS_CFLAGS),$(KBUILD_CFLAGS))
+CC_OPTION_CFLAGS = $(filter-out $(GCC_PLUGINS_CFLAGS) -fdump-ipa-clones,$(KBUILD_CFLAGS))
 
 # cc-option
 # Usage: cflags-y += $(call cc-option,-march=winchip-c6,-march=i586)
