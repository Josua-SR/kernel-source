From: Jason Wang <jasowang@redhat.com>
Date: Wed, 12 Sep 2018 11:17:05 +0800
Subject: tuntap: move XDP flushing out of tun_do_xdp()
Patch-mainline: v4.20-rc1
Git-commit: 1a097910adda6b3328fc235575bba0e9ee408492
References: bsc#1109837

This will allow adding batch flushing on top.

Signed-off-by: Jason Wang <jasowang@redhat.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Thomas Bogendoerfer <tbogendoerfer@suse.de>
---
 drivers/net/tun.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/drivers/net/tun.c
+++ b/drivers/net/tun.c
@@ -1615,7 +1615,6 @@ static int tun_xdp_act(struct tun_struct
 	switch (act) {
 	case XDP_REDIRECT:
 		err = xdp_do_redirect(tun->dev, xdp, xdp_prog);
-		xdp_do_flush_map();
 		if (err)
 			return err;
 		break;
@@ -1704,6 +1703,8 @@ static struct sk_buff *tun_build_skb(str
 		err = tun_xdp_act(tun, xdp_prog, &xdp, act);
 		if (err < 0)
 			goto err_xdp;
+		if (err == XDP_REDIRECT)
+			xdp_do_flush_map();
 		if (err != XDP_PASS)
 			goto out;
 
