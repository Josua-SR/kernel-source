From: Sagi Grimberg <sagi@grimberg.me>
Date: Thu, 22 Aug 2019 10:51:17 -0700
Subject: [PATCH] nvme-pci: set ctrl sqsize to the device q_depth
References: bsc#1156419,jsc#SLE-8281
Git-commit: aa22c8e6650d29a00196087caa2bbb32dc6117bc
Patch-mainline: v5.4-rc1

Align with what the rest of the transports are doing.

Signed-off-by: Sagi Grimberg <sagi@grimberg.me>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 drivers/nvme/host/pci.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/drivers/nvme/host/pci.c b/drivers/nvme/host/pci.c
index 20c6651c3b3e..c0e34d6614b8 100644
--- a/drivers/nvme/host/pci.c
+++ b/drivers/nvme/host/pci.c
@@ -2317,6 +2317,7 @@ static int nvme_pci_enable(struct nvme_dev *dev)
 
 	dev->q_depth = min_t(int, NVME_CAP_MQES(dev->ctrl.cap) + 1,
 				io_queue_depth);
+	dev->ctrl.sqsize = dev->q_depth - 1; /* 0's based queue depth */
 	dev->db_stride = 1 << NVME_CAP_STRIDE(dev->ctrl.cap);
 	dev->dbs = dev->bar + 4096;
 
-- 
2.16.4

