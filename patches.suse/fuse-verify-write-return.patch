From 8aab336b14c115c6bf1d4baeb9247e41ed9ce6de Mon Sep 17 00:00:00 2001
From: Miklos Szeredi <mszeredi@redhat.com>
Date: Tue Nov 12 11:49:04 2019 +0100
Subject: [PATCH] fuse: verify write return 
Git-commit: 8aab336b14c115c6bf1d4baeb9247e41ed9ce6de
References: git-fixes
Patch-mainline: v5.5-rc1


Make sure filesystem is not returning a bogus number of bytes written.

Fixes: ea9b9907b82a ("fuse: implement perform_write")
Cc: <stable@vger.kernel.org> # v2.6.26
Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
Acked-by: Goldwyn Rodrigues <rgoldwyn@suse.com>

---
 fs/fuse/file.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/fs/fuse/file.c
+++ b/fs/fuse/file.c
@@ -1036,6 +1036,8 @@
 		fuse_wait_on_page_writeback(inode, req->pages[i]->index);
 
 	res = fuse_send_write(req, &io, pos, count, NULL);
+	if (!res && req->misc.write.out.size > count)
+		res = -EIO;
 
 	offset = req->page_descs[0].offset;
 	count = res;
