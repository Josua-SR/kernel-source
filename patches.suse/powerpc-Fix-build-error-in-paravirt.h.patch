From 3aa193c6a2a8bb8b44a66b2ae43315410a0f8dfc Mon Sep 17 00:00:00 2001
From: Michal Suchanek <msuchanek@suse.de>
Date: Wed, 20 Jan 2021 12:57:28 +0100
Subject: [PATCH] powerpc: Fix build error in paravirt.h
To: linuxppc-dev@lists.ozlabs.org
Cc: Juergen Gross <jgross@suse.com>, Deep Shah <sdeep@vmware.com>, "VMware,  Inc." <pv-drivers@vmware.com>, Michael Ellerman <mpe@ellerman.id.au>, Benjamin Herrenschmidt <benh@kernel.crashing.org>, Paul Mackerras <paulus@samba.org>, Waiman Long <longman@redhat.com>, Srikar Dronamraju <srikar@linux.vnet.ibm.com>, virtualization@lists.linux-foundation.org, linuxppc-dev@lists.ozlabs.org, linux-kernel@vger.kernel.org

References: bsc#1181148 ltc#190702
Patch-mainline: submitted https://lore.kernel.org/linuxppc-dev/20210120132838.15589-1-msuchanek@suse.de/T/#u

./arch/powerpc/include/asm/spinlock.h:83:44: error: implicit declaration
of function 'smp_processor_id'; did you mean 'raw_smp_processor_id'?

smp_processor_id is defined in linux/smp.h but it is not included.

The build error happens only when the patch is applied to 5.3 kernel but
in only works by chance in mainline.

Fixes: ca3f969dcb11 ("powerpc/paravirt: Use is_kvm_guest() in vcpu_is_preempted()")
Signed-off-by: Michal Suchanek <msuchanek@suse.de>
---
 arch/powerpc/include/asm/spinlock.h | 1 +
 1 file changed, 1 insertion(+)

diff --git a/arch/powerpc/include/asm/spinlock.h b/arch/powerpc/include/asm/spinlock.h
--- a/arch/powerpc/include/asm/spinlock.h
+++ b/arch/powerpc/include/asm/spinlock.h
@@ -10,6 +10,7 @@
 #endif
 
 #ifdef CONFIG_PPC_PSERIES
+#include <linux/smp.h>
 #include <asm/kvm_guest.h>
 #include <asm/cputhreads.h>
 
-- 
2.26.2

