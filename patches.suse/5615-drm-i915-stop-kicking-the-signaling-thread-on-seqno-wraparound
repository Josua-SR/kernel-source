From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Tue, 6 Mar 2018 13:01:42 +0000
Subject: drm/i915: Stop kicking the signaling thread on seqno wraparound
Git-commit: 93eef7d65329b62cf8a6db918fe5ca5d84eedf50
Patch-mainline: v4.17-rc1
References: FATE#326289 FATE#326079 FATE#326049 FATE#322398 FATE#326166

Since commit fd10e2ce9905 ("drm/i915/breadcrumbs: Ignore unsubmitted
signalers"), we cancel the signaler when retiring the request and so
upon wraparound, where we wait for all requests to be retired, we no
longer need to spin waiting for the signaling thread to release its
references to the in-flight requests, and so we can assert that the
signaler is idle.

References: fd10e2ce9905 ("drm/i915/breadcrumbs: Ignore unsubmitted signalers")
Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
Cc: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Reviewed-by: Joonas Lahtinen <joonas.lahtinen@linux.intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20180306130143.13312-1-chris@chris-wilson.co.uk

Acked-by: Petr Tesarik <ptesarik@suse.com>
---
 drivers/gpu/drm/i915/i915_request.c      |    2 ++
 drivers/gpu/drm/i915/intel_breadcrumbs.c |    5 -----
 2 files changed, 2 insertions(+), 5 deletions(-)

--- a/drivers/gpu/drm/i915/i915_request.c
+++ b/drivers/gpu/drm/i915/i915_request.c
@@ -220,6 +220,8 @@ static int reset_all_global_seqno(struct
 			/* spin until threads are complete */
 			while (intel_breadcrumbs_busy(engine))
 				cond_resched();
+
+			GEM_BUG_ON(!list_empty(&engine->breadcrumbs.signals));
 		}
 
 		/* Check we are idle before we fiddle with hw state! */
--- a/drivers/gpu/drm/i915/intel_breadcrumbs.c
+++ b/drivers/gpu/drm/i915/intel_breadcrumbs.c
@@ -889,11 +889,6 @@ bool intel_breadcrumbs_busy(struct intel
 		spin_unlock_irq(&b->irq_lock);
 	}
 
-	if (!busy && !list_empty(&b->signals)) {
-		wake_up_process(b->signaler);
-		busy = true;
-	}
-
 	return busy;
 }
 
