From: Joerg Roedel <jroedel@suse.de>
Date: Tue, 2 Feb 2021 15:54:19 +0100
Subject: iommu: Check dev->iommu in dev_iommu_priv_get() before dereferencing
 it
Git-commit: 4c9fb5d9140802db4db9f66c23887f43174e113c
Patch-mainline: v5.11-rc7
References: bsc#1183311

The dev_iommu_priv_get() needs a similar check to
dev_iommu_fwspec_get() to make sure no NULL-ptr is dereferenced.

Fixes: 05a0542b456e1 ("iommu/amd: Store dev_data as device iommu private data")
Cc: stable@vger.kernel.org	# v5.8+
Link: https://lore.kernel.org/r/20210202145419.29143-1-joro@8bytes.org
Reference: https://bugzilla.kernel.org/show_bug.cgi?id=211241
Signed-off-by: Joerg Roedel <jroedel@suse.de>
---
 include/linux/iommu.h |    5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

--- a/include/linux/iommu.h
+++ b/include/linux/iommu.h
@@ -617,7 +617,10 @@ static inline void dev_iommu_fwspec_set(
 
 static inline void *dev_iommu_priv_get(struct device *dev)
 {
-	return dev->iommu->priv;
+	if (dev->iommu)
+		return dev->iommu->priv;
+	else
+		return NULL;
 }
 
 static inline void dev_iommu_priv_set(struct device *dev, void *priv)

