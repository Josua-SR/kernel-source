From ab00eb22174338ce5c58e24b44070f83c5c807e7 Mon Sep 17 00:00:00 2001
From: Michal Suchanek <msuchanek@suse.de>
Date: Wed, 3 Jul 2019 19:28:47 +0200
Subject: [PATCH] scsi: qla2xxx: do not crash on uninitialized pool list.

References: boo#1138874
Patch-mainline: no, under development

There is a crash reported in qla2x00_mem_free that points at
pool.unusable.head being uninitialized.

It is not clear if we are missing a fix that would prevent this issue or if this
is expected and the log spam should be just removed from this patch.

With this patch these mesages are printed:

[    5.818807] qla2xxx [0000:18:00.0]-00ba:3: -> fwdt1 no template
[    5.882435] scsi host3: qla2xxx
[    7.702749] qla2xxx [0000:18:00.0]-500a:3: LOOP UP detected (16 Gbps).
[    7.942351] qla2xxx [0000:18:00.0]-00fb:3: QLogic QLE2742 - QLogic 32Gb 2-port FC to PCIe Gen3 x8 Adapter.
[    7.942364] qla2xxx [0000:18:00.0]-00fc:3: ISP2261: PCIe (8.0GT/s x8) @ 0000:18:00.0 hdma+ host#=3 fw=8.03.07 (d0d5).
[    7.942832] qla2xxx [0000:18:00.1]-011c: : MSI-X vector count: 16.
[    7.942836] qla2xxx [0000:18:00.1]-001d: : Found an ISP2261 irq 115 iobase 0xffffc9000c77d000.
[    7.978557] qla2xxx [0000:18:00.1]-0075:12: ZIO mode 6 enabled; timer delay (200 us).
[    9.746809] qla2xxx [0000:18:00.1]-00ba:12: -> fwdt1 no template
[    9.806488] scsi host12: qla2xxx
[   11.618946] qla2xxx [0000:18:00.1]-500a:12: LOOP UP detected (16 Gbps).
[   11.846362] qla2xxx [0000:18:00.1]-00fb:12: QLogic QLE2742 - QLogic 32Gb 2-port FC to PCIe Gen3 x8 Adapter.
[   11.846374] qla2xxx [0000:18:00.1]-00fc:12: ISP2261: PCIe (8.0GT/s x8) @ 0000:18:00.1 hdma+ host#=12 fw=8.03.07 (d0d5).
[   11.846785] qla2xxx [0000:5e:00.0]-011c: : MSI-X vector count: 16.
[   11.846789] qla2xxx [0000:5e:00.0]-001d: : Found an ISP2261 irq 132 iobase 0xffffc9000c78d000.
[   11.879969] qla2xxx [0000:5e:00.0]-0075:13: ZIO mode 6 enabled; timer delay (200 us).
[   13.842810] qla2xxx [0000:5e:00.0]-00ba:13: -> fwdt1 no template
[   13.982488] scsi host13: qla2xxx
[   15.714982] qla2xxx [0000:5e:00.0]-500a:13: LOOP UP detected (16 Gbps).
[   16.002302] qla2xxx [0000:5e:00.0]-00fb:13: QLogic QLE2742 - QLogic 32Gb 2-port FC to PCIe Gen3 x8 Adapter.
[   16.002314] qla2xxx [0000:5e:00.0]-00fc:13: ISP2261: PCIe (8.0GT/s x8) @ 0000:5e:00.0 hdma+ host#=13 fw=8.05.61 (d0d5).
[   16.002675] qla2xxx [0000:5e:00.1]-011c: : MSI-X vector count: 16.
[   16.002679] qla2xxx [0000:5e:00.1]-001d: : Found an ISP2261 irq 149 iobase 0xffffc9000c7a5000.
[   16.035896] qla2xxx [0000:5e:00.1]-0075:14: ZIO mode 6 enabled; timer delay (200 us).
[   17.838808] qla2xxx [0000:5e:00.1]-00ba:14: -> fwdt1 no template
[   17.978487] scsi host14: qla2xxx
[   19.739357] qla2xxx [0000:5e:00.1]-500a:14: LOOP UP detected (16 Gbps).
[   20.038359] qla2xxx [0000:5e:00.1]-00fb:14: QLogic QLE2742 - QLogic 32Gb 2-port FC to PCIe Gen3 x8 Adapter.
[   20.038371] qla2xxx [0000:5e:00.1]-00fc:14: ISP2261: PCIe (8.0GT/s x8) @ 0000:5e:00.1 hdma+ host#=14 fw=8.05.61 (d0d5).
[   20.038873] qla2xxx [0000:d8:00.0]-011c: : MSI-X vector count: 16.
[   20.038879] qla2xxx [0000:d8:00.0]-001d: : Found an ISP2261 irq 166 iobase 0xffffc9000c7b5000.
[   20.072175] qla2xxx [0000:d8:00.0]-0075:15: ZIO mode 6 enabled; timer delay (200 us).
[   21.978814] qla2xxx [0000:d8:00.0]-00ba:15: -> fwdt1 no template
[   22.038445] scsi host15: qla2xxx
[   23.839169] qla2xxx [0000:d8:00.0]-500a:15: LOOP UP detected (16 Gbps).
[   24.098368] qla2xxx [0000:d8:00.0]-00fb:15: QLogic QLE2742 - QLogic 32Gb 2-port FC to PCIe Gen3 x8 Adapter.
[   24.098380] qla2xxx [0000:d8:00.0]-00fc:15: ISP2261: PCIe (8.0GT/s x8) @ 0000:d8:00.0 hdma+ host#=15 fw=8.03.07 (d0d5).
[   24.098668] qla2xxx [0000:d8:00.1]-011c: : MSI-X vector count: 16.
[   24.098672] qla2xxx [0000:d8:00.1]-001d: : Found an ISP2261 irq 183 iobase 0xffffc9000c7c5000.
[   24.132307] qla2xxx [0000:d8:00.1]-0075:16: ZIO mode 6 enabled; timer delay (200 us).
[   25.886807] qla2xxx [0000:d8:00.1]-00ba:16: -> fwdt1 no template
[   25.946505] scsi host16: qla2xxx
[   27.751267] qla2xxx [0000:d8:00.1]-500a:16: LOOP UP detected (16 Gbps).
[   28.006371] qla2xxx [0000:d8:00.1]-00fb:16: QLogic QLE2742 - QLogic 32Gb 2-port FC to PCIe Gen3 x8 Adapter.
[   28.006383] qla2xxx [0000:d8:00.1]-00fc:16: ISP2261: PCIe (8.0GT/s x8) @ 0000:d8:00.1 hdma+ host#=16 fw=8.03.07 (d0d5).
...
[  198.322711] qla2xxx [0000:18:00.0]-b079:3: Removing driver
[  198.322718] qla2xxx [0000:18:00.0]-00af:3: Performing ISP error recovery - ha=ffff881fefd1b000.
[  198.324535] qla2xxx 0000:18:00.0: ha->pool.unusable.head not initialized
[  198.324539] qla2xxx 0000:18:00.0: ha->pool.good.head not initialized
[  198.419694] qla2xxx [0000:18:00.1]-b079:12: Removing driver
[  198.419701] qla2xxx [0000:18:00.1]-00af:12: Performing ISP error recovery - ha=ffff881fe3f28000.
[  198.421348] qla2xxx 0000:18:00.1: ha->pool.unusable.head not initialized
[  198.421352] qla2xxx 0000:18:00.1: ha->pool.good.head not initialized
[  198.520414] qla2xxx [0000:5e:00.0]-b079:13: Removing driver
[  198.520420] qla2xxx [0000:5e:00.0]-00af:13: Performing ISP error recovery - ha=ffff881fe3f15000.
[  198.522136] qla2xxx 0000:5e:00.0: ha->pool.unusable.head not initialized
[  198.522139] qla2xxx 0000:5e:00.0: ha->pool.good.head not initialized
[  198.622507] qla2xxx [0000:5e:00.1]-b079:14: Removing driver
[  198.622514] qla2xxx [0000:5e:00.1]-00af:14: Performing ISP error recovery - ha=ffff881fe3f09000.
[  198.623942] qla2xxx 0000:5e:00.1: ha->pool.unusable.head not initialized
[  198.623945] qla2xxx 0000:5e:00.1: ha->pool.good.head not initialized
[  198.713427] qla2xxx [0000:d8:00.0]-b079:15: Removing driver
[  198.713433] qla2xxx [0000:d8:00.0]-00af:15: Performing ISP error recovery - ha=ffff8820f0dd4000.
[  198.714699] qla2xxx 0000:d8:00.0: ha->pool.unusable.head not initialized
[  198.714702] qla2xxx 0000:d8:00.0: ha->pool.good.head not initialized
[  198.812400] qla2xxx [0000:d8:00.1]-b079:16: Removing driver
[  198.812406] qla2xxx [0000:d8:00.1]-00af:16: Performing ISP error recovery - ha=ffff8820f0dce000.
[  198.813711] qla2xxx 0000:d8:00.1: ha->pool.unusable.head not initialized
[  198.813714] qla2xxx 0000:d8:00.1: ha->pool.good.head not initialized

Signed-off-by: Michal Suchanek <msuchanek@suse.de>
---
 drivers/scsi/qla2xxx/qla_os.c | 43 ++++++++++++++++++++---------------
 1 file changed, 25 insertions(+), 18 deletions(-)

diff --git a/drivers/scsi/qla2xxx/qla_os.c b/drivers/scsi/qla2xxx/qla_os.c
index 19f88908f734..c2a11d434af2 100644
--- a/drivers/scsi/qla2xxx/qla_os.c
+++ b/drivers/scsi/qla2xxx/qla_os.c
@@ -4777,24 +4777,31 @@ qla2x00_mem_free(struct qla_hw_data *ha)
 	if (ql2xenabledif) {
 		struct dsd_dma *dsd, *nxt;
 
-		list_for_each_entry_safe(dsd, nxt, &ha->pool.unusable.head,
-					 list) {
-			list_del(&dsd->list);
-			dma_pool_free(ha->dif_bundl_pool, dsd->dsd_addr,
-				      dsd->dsd_list_dma);
-			ha->dif_bundle_dma_allocs--;
-			kfree(dsd);
-			ha->dif_bundle_kallocs--;
-			ha->pool.unusable.count--;
-		}
-		list_for_each_entry_safe(dsd, nxt, &ha->pool.good.head, list) {
-			list_del(&dsd->list);
-			dma_pool_free(ha->dif_bundl_pool, dsd->dsd_addr,
-				      dsd->dsd_list_dma);
-			ha->dif_bundle_dma_allocs--;
-			kfree(dsd);
-			ha->dif_bundle_kallocs--;
-		}
+		if (!ha->pool.unusable.head.next)
+			pci_warn(ha->pdev, "ha->pool.unusable.head not initialized\n");
+		else
+			list_for_each_entry_safe(dsd, nxt, &ha->pool.unusable.head,
+					list) {
+				list_del(&dsd->list);
+				dma_pool_free(ha->dif_bundl_pool, dsd->dsd_addr,
+						dsd->dsd_list_dma);
+				ha->dif_bundle_dma_allocs--;
+				kfree(dsd);
+				ha->dif_bundle_kallocs--;
+				ha->pool.unusable.count--;
+			}
+		if (!ha->pool.good.head.next)
+			pci_warn(ha->pdev, "ha->pool.good.head not initialized\n");
+		else
+			list_for_each_entry_safe(dsd, nxt, &ha->pool.good.head, list) {
+				list_del(&dsd->list);
+				dma_pool_free(ha->dif_bundl_pool, dsd->dsd_addr,
+						dsd->dsd_list_dma);
+				ha->dif_bundle_dma_allocs--;
+				kfree(dsd);
+				ha->dif_bundle_kallocs--;
+				ha->pool.good.count--;
+			}
 	}
 
 	if (ha->dif_bundl_pool)
-- 
2.21.0

