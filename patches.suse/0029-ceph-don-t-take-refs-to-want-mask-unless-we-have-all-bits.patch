From: "Yan, Zheng" <ukernel@gmail.com>
Date: Tue, 18 Feb 2020 08:17:08 -0500
Subject: ceph: don't take refs to want mask unless we have all bits
Git-commit: 173e70e8ac0f1e7e3eb98f1ffb953e80a5cc8a5f
Patch-mainline: v5.7-rc1
References: jsc#SES-1134

If we don't have all of the cap bits for the want mask in
try_get_cap_refs, then just take refs on the need bits.

Signed-off-by: "Yan, Zheng" <ukernel@gmail.com>
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
Acked-by: Luis Henriques <lhenriques@suse.com>
---
 fs/ceph/caps.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/fs/ceph/caps.c b/fs/ceph/caps.c
index d3274120f738..d09b9d91cf4f 100644
--- a/fs/ceph/caps.c
+++ b/fs/ceph/caps.c
@@ -2666,7 +2666,10 @@ static int try_get_cap_refs(struct inode *inode, int need, int want,
 				}
 				snap_rwsem_locked = true;
 			}
-			*got = need | (have & want);
+			if ((have & want) == want)
+				*got = need | want;
+			else
+				*got = need;
 			if (S_ISREG(inode->i_mode) &&
 			    (need & CEPH_CAP_FILE_RD) &&
 			    !(*got & CEPH_CAP_FILE_CACHE))

