From 180ac48ee62f53c26787350a956c5ac371cbe0b7 Mon Sep 17 00:00:00 2001
From: Felix Fietkau <nbd@nbd.name>
Date: Sun, 26 Jul 2020 15:09:47 +0200
Subject: [PATCH] mac80211: calculate skb hash early when using itxq
Git-commit: 180ac48ee62f53c26787350a956c5ac371cbe0b7
Patch-mainline: v5.9-rc1
References: jsc#SLE-13430

This avoids flow separation issues when using software encryption.

Signed-off-by: Felix Fietkau <nbd@nbd.name>
Link: https://lore.kernel.org/r/20200726130947.88145-2-nbd@nbd.name
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 net/mac80211/tx.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/net/mac80211/tx.c b/net/mac80211/tx.c
index 7c0abe477b03..fd44a71eea58 100644
--- a/net/mac80211/tx.c
+++ b/net/mac80211/tx.c
@@ -3952,6 +3952,7 @@ void __ieee80211_subif_start_xmit(struct sk_buff *skb,
 	if (local->ops->wake_tx_queue) {
 		u16 queue = __ieee80211_select_queue(sdata, sta, skb);
 		skb_set_queue_mapping(skb, queue);
+		skb_get_hash(skb);
 	}
 
 	if (sta) {
-- 
2.16.4

