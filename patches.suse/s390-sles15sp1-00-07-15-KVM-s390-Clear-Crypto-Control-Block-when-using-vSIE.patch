From: Farhan Ali <alifm@linux.ibm.com>
Subject: KVM: s390: Clear Crypto Control Block when using vSIE
Patch-mainline: v4.20-rc1
Git-commit: 6cc571b1b1e8b6fbcf69411d115cf9d9be866276
References: FATE#326370, LTC#169186, bsc#1113483

Summary:     kernel: AP Crypto Passthrough 
Description: This adds support for AP crypto passthrough for 
             kvm guests.

Upstream-Description:

             KVM: s390: Clear Crypto Control Block when using vSIE

             When we clear the Crypto Control Block (CRYCB) used by a guest
             level 2, the vSIE shadow CRYCB for guest level 3 must be updated
             before the guest uses it.

             We achieve this by using the KVM_REQ_VSIE_RESTART synchronous
             request for each vCPU belonging to the guest to force the reload
             of the shadow CRYCB before rerunning the guest level 3.

             Signed-off-by: Pierre Morel <pmorel@linux.ibm.com>
             Signed-off-by: Tony Krowiak <akrowiak@linux.ibm.com>
             Message-Id: <20180925231641.4954-16-akrowiak@linux.vnet.ibm.com>
             Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>

Signed-off-by: Farhan Ali <alifm@linux.ibm.com>
Acked-by: Petr Tesarik <ptesarik@suse.com>
---
 arch/s390/kvm/kvm-s390.c |    2 ++
 1 file changed, 2 insertions(+)

--- a/arch/s390/kvm/kvm-s390.c
+++ b/arch/s390/kvm/kvm-s390.c
@@ -1951,6 +1951,8 @@ void kvm_arch_crypto_clear_masks(struct
 	memset(&kvm->arch.crypto.crycb->apcb1, 0,
 	       sizeof(kvm->arch.crypto.crycb->apcb1));
 
+	/* recreate the shadow crycb for each vcpu */
+	kvm_s390_sync_request_broadcast(kvm, KVM_REQ_VSIE_RESTART);
 	kvm_s390_vcpu_unblock_all(kvm);
 	mutex_unlock(&kvm->lock);
 }
