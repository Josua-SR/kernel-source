From: Eran Ben Elisha <eranbe@mellanox.com>
Date: Wed, 13 Dec 2017 13:04:01 +0200
Subject: net/mlx5e: Add Event Queue meta data info for TX timeout logs
Patch-mainline: v4.16-rc1
Git-commit: 3a32b26a4eccb37435d81bf75e41b2bd4464f8d6
References: bsc#1103990 FATE#326006

When TX timeout occurs, EQ consumer index and irqn can help in debug for
understanding the SW state of EQ. Add them to the logger prints for the
relevant EQ only.

Signed-off-by: Eran Ben Elisha <eranbe@mellanox.com>
Reviewed-by: Tariq Toukan <tariqt@mellanox.com>
Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
Acked-by: Thomas Bogendoerfer <tbogendoerfer@suse.de>
---
 drivers/net/ethernet/mellanox/mlx5/core/en_main.c |   12 ++++++++++++
 1 file changed, 12 insertions(+)

--- a/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
@@ -3768,6 +3768,9 @@ static void mlx5e_tx_timeout(struct net_
 	for (i = 0; i < priv->channels.num * priv->channels.params.num_tc; i++) {
 		struct netdev_queue *dev_queue = netdev_get_tx_queue(dev, i);
 		struct mlx5e_txqsq *sq = priv->txq2sq[i];
+		struct mlx5_core_dev *mdev = priv->mdev;
+		int irqn_not_used, eqn;
+		struct mlx5_eq *eq;
 
 		if (!netif_xmit_stopped(dev_queue))
 			continue;
@@ -3776,6 +3779,15 @@ static void mlx5e_tx_timeout(struct net_
 		netdev_err(dev, "TX timeout on queue: %d, SQ: 0x%x, CQ: 0x%x, SQ Cons: 0x%x SQ Prod: 0x%x, usecs since last trans: %u\n",
 			   i, sq->sqn, sq->cq.mcq.cqn, sq->cc, sq->pc,
 			   jiffies_to_usecs(jiffies - dev_queue->trans_start));
+
+		if (mlx5_vector2eqn(mdev, sq->cq.mcq.vector, &eqn,
+				    &irqn_not_used))
+			continue;
+
+		eq = mlx5_eqn2eq(mdev, eqn);
+		if (!IS_ERR(eq))
+			netdev_err(dev, "EQ 0x%x: Cons = 0x%x, irqn = 0x%x\n",
+				   eqn, eq->cons_index, eq->irqn);
 	}
 
 	if (sched_work && test_bit(MLX5E_STATE_OPENED, &priv->state))
