From: Christoph Hellwig <hch@lst.de>
Date: Thu, 23 Jul 2020 08:08:45 +0200
Subject: bpfilter: reject kernel addresses
Patch-mainline: v5.9-rc1
Git-commit: d200cf624c9247ab52b67d34d9e198262a23df31
References: bsc#1155518

The bpfilter user mode helper processes the optval address using
process_vm_readv.  Don't send it kernel addresses fed under
set_fs(KERNEL_DS) as that won't work.

Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Gary Lin <glin@suse.com>
---
 net/bpfilter/bpfilter_kern.c |    4 ++++
 1 file changed, 4 insertions(+)

--- a/net/bpfilter/bpfilter_kern.c
+++ b/net/bpfilter/bpfilter_kern.c
@@ -72,6 +72,10 @@ static int bpfilter_process_sockopt(stru
 		.addr		= (uintptr_t)optval,
 		.len		= optlen,
 	};
+	if (uaccess_kernel()) {
+		pr_err("kernel access not supported\n");
+		return -EFAULT;
+	}
 	return bpfilter_send_req(&req);
 }
 
