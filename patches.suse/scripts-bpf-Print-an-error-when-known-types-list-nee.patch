From: Jakub Sitnicki <jakub@cloudflare.com>
Date: Sun, 20 Oct 2019 13:23:44 +0200
Subject: scripts/bpf: Print an error when known types list needs updating
Patch-mainline: v5.5-rc1
Git-commit: ab81e203bc0d4a4542bca2498535f8761a3cfd92
References: bsc#1177028

Don't generate a broken bpf_helper_defs.h header if the helper script needs
updating because it doesn't recognize a newly added type. Instead print an
error that explains why the build is failing, clean up the partially
generated header and stop.

v1->v2:
- Switched from temporary file to .DELETE_ON_ERROR.

Fixes: 456a513bb5d4 ("scripts/bpf: Emit an #error directive known types list needs updating")
Suggested-by: Andrii Nakryiko <andriin@fb.com>
Signed-off-by: Jakub Sitnicki <jakub@cloudflare.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Acked-by: Yonghong Song <yhs@fb.com>
Acked-by: Andrii Nakryiko <andriin@fb.com>
Link: https://lore.kernel.org/bpf/20191020112344.19395-1-jakub@cloudflare.com
Acked-by: Gary Lin <glin@suse.com>
---
 scripts/bpf_helpers_doc.py |    4 ++--
 tools/lib/bpf/Makefile     |    3 +++
 2 files changed, 5 insertions(+), 2 deletions(-)

--- a/scripts/bpf_helpers_doc.py
+++ b/scripts/bpf_helpers_doc.py
@@ -488,8 +488,8 @@ class PrinterHelpers(Printer):
             return t
         if t in self.mapped_types:
             return self.mapped_types[t]
-        print("")
-        print("#error \"Unrecognized type '%s', please add it to known types!\"" % t)
+        print("Unrecognized type '%s', please add it to known types!" % t,
+              file=sys.stderr)
         sys.exit(1)
 
     seen_helpers = set()
--- a/tools/lib/bpf/Makefile
+++ b/tools/lib/bpf/Makefile
@@ -300,3 +300,6 @@ tags:
 # Declare the contents of the .PHONY variable as phony.  We keep that
 # information in a variable so we can use it in if_changed and friends.
 .PHONY: $(PHONY)
+
+# Delete partially updated (corrupted) files on error
+.DELETE_ON_ERROR:
