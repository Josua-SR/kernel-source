From: Takashi Iwai <tiwai@suse.de>
Subject: [PATCH] ima: Fix Oops at boot with ima_template_fmt=d boot option
Patch-mainline: Submitted, linux-integrity ML
References: bsc#1172223

The recent changes to IMA to add support of SHA256 caused a
regression, triggering a NULL dereference at boot when
ima_template_fmt=d option is passed.

Add a NULL check for avoiding the crash.

Fixes: 6f1a1d103b48 ("ima: Switch to ima_hash_algo for boot aggregate")
Buglink: https://bugzilla.suse.com/show_bug.cgi?id=1172223
Link: https://lore.kernel.org/r/s5htv00m5sb.wl-tiwai@suse.de/
Signed-off-by: Takashi Iwai <tiwai@suse.de>

---
 security/integrity/ima/ima_appraise.c |    3 +++
 1 file changed, 3 insertions(+)

--- a/security/integrity/ima/ima_appraise.c
+++ b/security/integrity/ima/ima_appraise.c
@@ -52,6 +52,9 @@ int ima_must_appraise(struct inode *inod
 	if (!ima_appraise)
 		return 0;
 
+	if (!ima_policy_flag)
+		return 0;
+
 	security_task_getsecid(current, &secid);
 	return ima_match_policy(inode, current_cred(), secid, func, mask,
 				IMA_APPRAISE | IMA_HASH, NULL, NULL);
