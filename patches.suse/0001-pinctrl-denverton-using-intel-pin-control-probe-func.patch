From: "Lee, Chun-Yi" <jlee@suse.com>
Date: Wed, 24 Jun 2020 14:29:52 +0800
Subject: [PATCH] pinctrl-denverton: using intel pin control probe function
 when probing by hid is failed
References: bsc#1172630
Patch-mainline: Never, Intel has responsibility for their drivers

Signed-off-by: "Lee, Chun-Yi" <jlee@suse.com>
---
 drivers/pinctrl/intel/pinctrl-denverton.c | 13 ++++++++++++-
 drivers/pinctrl/intel/pinctrl-intel.c     |  5 +++--
 drivers/pinctrl/intel/pinctrl-intel.h     |  2 ++
 3 files changed, 17 insertions(+), 3 deletions(-)

diff --git a/drivers/pinctrl/intel/pinctrl-denverton.c b/drivers/pinctrl/intel/pinctrl-denverton.c
index 3a4932b..5663736 100644
--- a/drivers/pinctrl/intel/pinctrl-denverton.c
+++ b/drivers/pinctrl/intel/pinctrl-denverton.c
@@ -257,6 +257,17 @@ static const struct intel_pinctrl_soc_data dnv_soc_data = {
 	.ncommunities = ARRAY_SIZE(dnv_communities),
 };
 
+static int dnv_pinctrl_probe(struct platform_device *pdev)
+{
+	int ret;
+
+	ret = intel_pinctrl_probe_by_hid(pdev);
+	if (ret)
+		ret = intel_pinctrl_probe(pdev, &dnv_soc_data);
+
+	return ret;
+}
+
 static INTEL_PINCTRL_PM_OPS(dnv_pinctrl_pm_ops);
 
 static const struct acpi_device_id dnv_pinctrl_acpi_match[] = {
@@ -266,7 +277,7 @@ static const struct acpi_device_id dnv_pinctrl_acpi_match[] = {
 MODULE_DEVICE_TABLE(acpi, dnv_pinctrl_acpi_match);
 
 static struct platform_driver dnv_pinctrl_driver = {
-	.probe = intel_pinctrl_probe_by_hid,
+	.probe = dnv_pinctrl_probe,
 	.driver = {
 		.name = "denverton-pinctrl",
 		.acpi_match_table = dnv_pinctrl_acpi_match,
diff --git a/drivers/pinctrl/intel/pinctrl-intel.c b/drivers/pinctrl/intel/pinctrl-intel.c
index 4ef81e7..61360e0 100644
--- a/drivers/pinctrl/intel/pinctrl-intel.c
+++ b/drivers/pinctrl/intel/pinctrl-intel.c
@@ -1327,8 +1327,8 @@ static int intel_pinctrl_pm_init(struct intel_pinctrl *pctrl)
 	return 0;
 }
 
-static int intel_pinctrl_probe(struct platform_device *pdev,
-			       const struct intel_pinctrl_soc_data *soc_data)
+int intel_pinctrl_probe(struct platform_device *pdev,
+			const struct intel_pinctrl_soc_data *soc_data)
 {
 	struct intel_pinctrl *pctrl;
 	int i, ret, irq;
@@ -1426,6 +1426,7 @@ static int intel_pinctrl_probe(struct platform_device *pdev,
 
 	return 0;
 }
+EXPORT_SYMBOL_GPL(intel_pinctrl_probe);
 
 int intel_pinctrl_probe_by_hid(struct platform_device *pdev)
 {
diff --git a/drivers/pinctrl/intel/pinctrl-intel.h b/drivers/pinctrl/intel/pinctrl-intel.h
index a8e958f..50589b2 100644
--- a/drivers/pinctrl/intel/pinctrl-intel.h
+++ b/drivers/pinctrl/intel/pinctrl-intel.h
@@ -173,6 +173,8 @@ struct intel_pinctrl_soc_data {
 	size_t ncommunities;
 };
 
+int intel_pinctrl_probe(struct platform_device *pdev,
+			const struct intel_pinctrl_soc_data *soc_data);
 int intel_pinctrl_probe_by_hid(struct platform_device *pdev);
 int intel_pinctrl_probe_by_uid(struct platform_device *pdev);
 
-- 
2.16.4

