From 2cc5cf1d94232e1f5127f4dc11ce8d6c0707772c Mon Sep 17 00:00:00 2001
From: Ben Skeggs <bskeggs@redhat.com>
Date: Sun, 21 Jun 2020 10:22:35 +1000
Subject: drm/nouveau/kms/nv50-: convert wimm update() to new push macros
Git-commit: 9659be21e8034528839216b21794da73fdbedec2
Patch-mainline: v5.9-rc1
References: jsc#SLE-12680, jsc#SLE-12880, jsc#SLE-12882, jsc#SLE-12883, jsc#SLE-13496, jsc#SLE-15322

Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
Reviewed-by: Lyude Paul <lyude@redhat.com>
Signed-off-by: Patrik Jakobsson <pjakobsson@suse.de>
---
 drivers/gpu/drm/nouveau/dispnv50/curs507a.c |  6 ++++--
 drivers/gpu/drm/nouveau/dispnv50/cursc37a.c |  6 ++++--
 drivers/gpu/drm/nouveau/dispnv50/wimmc37b.c | 21 +++++++++++----------
 drivers/gpu/drm/nouveau/dispnv50/wndw.h     |  2 +-
 4 files changed, 20 insertions(+), 15 deletions(-)

diff --git a/drivers/gpu/drm/nouveau/dispnv50/curs507a.c b/drivers/gpu/drm/nouveau/dispnv50/curs507a.c
index babf680c25fd..47f6f01b52a0 100644
--- a/drivers/gpu/drm/nouveau/dispnv50/curs507a.c
+++ b/drivers/gpu/drm/nouveau/dispnv50/curs507a.c
@@ -40,11 +40,13 @@ curs507a_space(struct nv50_wndw *wndw)
 	return false;
 }
 
-static void
+static int
 curs507a_update(struct nv50_wndw *wndw, u32 *interlock)
 {
-	if (curs507a_space(wndw))
+	int ret = nvif_chan_wait(&wndw->wimm, 1);
+	if (ret == 0)
 		nvif_wr32(&wndw->wimm.base.user, 0x0080, 0x00000000);
+	return ret;
 }
 
 static int
diff --git a/drivers/gpu/drm/nouveau/dispnv50/cursc37a.c b/drivers/gpu/drm/nouveau/dispnv50/cursc37a.c
index 45c1c33e950a..9d96a246b39a 100644
--- a/drivers/gpu/drm/nouveau/dispnv50/cursc37a.c
+++ b/drivers/gpu/drm/nouveau/dispnv50/cursc37a.c
@@ -22,11 +22,13 @@
 #include "curs.h"
 #include "atom.h"
 
-static void
+static int
 cursc37a_update(struct nv50_wndw *wndw, u32 *interlock)
 {
-	if (curs507a_space(wndw))
+	int ret = nvif_chan_wait(&wndw->wimm, 1);
+	if (ret == 0)
 		nvif_wr32(&wndw->wimm.base.user, 0x0200, 0x00000001);
+	return ret;
 }
 
 static int
diff --git a/drivers/gpu/drm/nouveau/dispnv50/wimmc37b.c b/drivers/gpu/drm/nouveau/dispnv50/wimmc37b.c
index 4eb5abfb8ebf..c2009d477736 100644
--- a/drivers/gpu/drm/nouveau/dispnv50/wimmc37b.c
+++ b/drivers/gpu/drm/nouveau/dispnv50/wimmc37b.c
@@ -26,18 +26,19 @@
 #include <nvif/clc37b.h>
 #include <nvif/pushc37b.h>
 
-static void
+static int
 wimmc37b_update(struct nv50_wndw *wndw, u32 *interlock)
 {
-	u32 *push;
-	if ((push = evo_wait(&wndw->wimm, 2))) {
-		evo_mthd(push, 0x0200, 1);
-		if (interlock[NV50_DISP_INTERLOCK_WNDW] & wndw->interlock.data)
-			evo_data(push, 0x00000003);
-		else
-			evo_data(push, 0x00000001);
-		evo_kick(push, &wndw->wimm);
-	}
+	struct nvif_push *push = wndw->wimm.push;
+	int ret;
+
+	if ((ret = PUSH_WAIT(push, 2)))
+		return ret;
+
+	PUSH_NVSQ(push, NVC37B, 0x0200, ((interlock[NV50_DISP_INTERLOCK_WNDW] &
+					  wndw->interlock.data) ? 0x00000002 : 0x00000000) |
+					0x00000001);
+	return PUSH_KICK(push);
 }
 
 static int
diff --git a/drivers/gpu/drm/nouveau/dispnv50/wndw.h b/drivers/gpu/drm/nouveau/dispnv50/wndw.h
index 53e496bfbc9d..ce1b2baf9d19 100644
--- a/drivers/gpu/drm/nouveau/dispnv50/wndw.h
+++ b/drivers/gpu/drm/nouveau/dispnv50/wndw.h
@@ -93,7 +93,7 @@ void base907c_csc(struct nv50_wndw *, struct nv50_wndw_atom *,
 struct nv50_wimm_func {
 	int (*point)(struct nv50_wndw *, struct nv50_wndw_atom *);
 
-	void (*update)(struct nv50_wndw *, u32 *interlock);
+	int (*update)(struct nv50_wndw *, u32 *interlock);
 };
 
 extern const struct nv50_wimm_func curs507a;
-- 
2.29.2

