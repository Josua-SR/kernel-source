From: Edwin Peer <edwin.peer@broadcom.com>
Date: Sun, 27 Sep 2020 13:42:16 -0400
Subject: bnxt_en: avoid link reset if speed is not changed
Patch-mainline: v5.10-rc1
Git-commit: 745b5c653913829ede6d4466f36b35426d6e1823
References: jsc#SLE-16649

PORT_PHY_CONFIG is always sent with REQ_FLAGS_RESET_PHY set. This flag
must be set in order for the firmware to institute the requested PHY
change immediately, but it results in a link flap. This is unnecessary
and results in an improved user experience if the PHY reconfiguration
is avoided when the user requested speed does not constitute a change.

Signed-off-by: Edwin Peer <edwin.peer@broadcom.com>
Signed-off-by: Michael Chan <michael.chan@broadcom.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Acked-by: Thomas Bogendoerfer <tbogendoerfer@suse.de>
---
 drivers/net/ethernet/broadcom/bnxt/bnxt_ethtool.c |   10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

--- a/drivers/net/ethernet/broadcom/bnxt/bnxt_ethtool.c
+++ b/drivers/net/ethernet/broadcom/bnxt/bnxt_ethtool.c
@@ -1737,6 +1737,11 @@ static int bnxt_force_link_speed(struct
 		return -EINVAL;
 	}
 
+	if (link_info->req_link_speed == fw_speed &&
+	    link_info->req_signal_mode == sig_mode &&
+	    link_info->autoneg == 0)
+		return -EALREADY;
+
 	link_info->req_link_speed = fw_speed;
 	link_info->req_signal_mode = sig_mode;
 	link_info->req_duplex = BNXT_LINK_DUPLEX_FULL;
@@ -1817,8 +1822,11 @@ static int bnxt_set_link_ksettings(struc
 		}
 		speed = base->speed;
 		rc = bnxt_force_link_speed(dev, speed);
-		if (rc)
+		if (rc) {
+			if (rc == -EALREADY)
+				rc = 0;
 			goto set_setting_exit;
+		}
 	}
 
 	if (netif_running(dev))
