From c2c24edb1d9c308011f5a1328563d8da8c92c849 Mon Sep 17 00:00:00 2001
From: Robin Murphy <robin.murphy@arm.com>
Date: Fri, 17 Jan 2020 15:48:39 +0000
Subject: [PATCH] arm64: csum: Fix pathological zero-length calls
Git-commit: c2c24edb1d9c308011f5a1328563d8da8c92c849
Patch-mainline: v5.6-rc1
References: bsc#1177591

In validating the checksumming results of the new routine, I sadly
neglected to test its not-checksumming results. Thus it slipped through
that the one case where @buff is already dword-aligned and @len = 0
manages to defeat the tail-masking logic and behave as if @len = 8.
For a zero length it doesn't make much sense to deference @buff anyway,
so just add an early return (which has essentially zero impact on
performance).

Signed-off-by: Robin Murphy <robin.murphy@arm.com>
Signed-off-by: Will Deacon <will@kernel.org>
Acked-by: Jessica Yu <jeyu@suse.de>
---
 arch/arm64/lib/csum.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/arch/arm64/lib/csum.c b/arch/arm64/lib/csum.c
index 847eb725ce09..1f82c66b32ea 100644
--- a/arch/arm64/lib/csum.c
+++ b/arch/arm64/lib/csum.c
@@ -20,6 +20,9 @@ unsigned int do_csum(const unsigned char *buff, int len)
 	const u64 *ptr;
 	u64 data, sum64 = 0;
 
+	if (unlikely(len == 0))
+		return 0;
+
 	offset = (unsigned long)buff & 7;
 	/*
 	 * This is to all intents and purposes safe, since rounding down cannot
-- 
2.16.4

