From 6ac3a0ebfcc2f0c75ca0ca6974389ce421aa5cbd Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Tue, 20 Aug 2019 13:21:18 +0100
Subject: dmabuf: Mark up onstack timer for selftests
Git-commit: 6ac3a0ebfcc2f0c75ca0ca6974389ce421aa5cbd
Patch-mainline: v5.4-rc1
References: bsc#1152472

The dma-fence selftest uses an on-stack timer that requires explicit
annotation for debugobjects.

Bugzilla: https://bugs.freedesktop.org/show_bug.cgi?id=111442
Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
Cc: Daniel Vetter <daniel.vetter@ffwll.ch>
Acked-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Link: https://patchwork.freedesktop.org/patch/msgid/20190820122118.13698-1-chris@chris-wilson.co.uk
Acked-by: Thomas Zimmermann <tzimmermann@suse.de>
---
 drivers/dma-buf/st-dma-fence.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/dma-buf/st-dma-fence.c b/drivers/dma-buf/st-dma-fence.c
index 6fbae6bf6576..e593064341c8 100644
--- a/drivers/dma-buf/st-dma-fence.c
+++ b/drivers/dma-buf/st-dma-fence.c
@@ -373,7 +373,7 @@ static int test_wait_timeout(void *arg)
 	struct wait_timer wt;
 	int err = -EINVAL;
 
-	timer_setup(&wt.timer, wait_timer, 0);
+	timer_setup_on_stack(&wt.timer, wait_timer, 0);
 
 	wt.f = mock_fence();
 	if (!wt.f)
@@ -399,6 +399,7 @@ static int test_wait_timeout(void *arg)
 	err = 0;
 err_free:
 	del_timer_sync(&wt.timer);
+	destroy_timer_on_stack(&wt.timer);
 	dma_fence_signal(wt.f);
 	dma_fence_put(wt.f);
 	return err;
-- 
2.28.0

