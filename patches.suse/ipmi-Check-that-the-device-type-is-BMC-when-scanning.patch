From eae4a36a6825302cb08c73c91924cade224d96d3 Mon Sep 17 00:00:00 2001
From: Corey Minyard <cminyard@mvista.com>
Date: Fri, 1 Sep 2017 10:46:47 -0500
Subject: [PATCH] ipmi: Check that the device type is BMC when scanning device
Git-commit: eae4a36a6825302cb08c73c91924cade224d96d3
Patch-mainline: v4.15-rc1
References: FATE#326156

Just an added safety check.

Signed-off-by: Corey Minyard <cminyard@mvista.com>
Acked-by: Takashi Iwai <tiwai@suse.de>

---
 drivers/char/ipmi/ipmi_msghandler.c | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/drivers/char/ipmi/ipmi_msghandler.c b/drivers/char/ipmi/ipmi_msghandler.c
index 5780fdf6bc7a..efa5581c2f8b 100644
--- a/drivers/char/ipmi/ipmi_msghandler.c
+++ b/drivers/char/ipmi/ipmi_msghandler.c
@@ -2433,9 +2433,11 @@ static const struct device_type bmc_device_type = {
 static int __find_bmc_guid(struct device *dev, void *data)
 {
 	unsigned char *id = data;
-	struct bmc_device *bmc = to_bmc_device(dev);
 
-	return memcmp(bmc->guid, id, 16) == 0;
+	if (dev->type != &bmc_device_type)
+		return 0;
+
+	return memcmp(to_bmc_device(dev)->guid, id, 16) == 0;
 }
 
 static struct bmc_device *ipmi_find_bmc_guid(struct device_driver *drv,
@@ -2458,8 +2460,12 @@ struct prod_dev_id {
 static int __find_bmc_prod_dev_id(struct device *dev, void *data)
 {
 	struct prod_dev_id *id = data;
-	struct bmc_device *bmc = to_bmc_device(dev);
+	struct bmc_device *bmc;
+
+	if (dev->type != &bmc_device_type)
+		return 0;
 
+	bmc = to_bmc_device(dev);
 	return (bmc->id.product_id == id->product_id
 		&& bmc->id.device_id == id->device_id);
 }
-- 
2.19.2

