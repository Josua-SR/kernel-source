From: Joerg Roedel <jroedel@suse.de>
Date: Wed, 10 Mar 2021 09:43:20 +0100
Subject: x86/boot/compressed/64: Reload CS in startup_32
Git-commit: 0c289ff81c24033777fab23019039f11e1449ba4
Patch-mainline: v5.13-rc1
References: jsc#SLE-14337

Exception handling in the startup_32 boot path requires the CS
selector to be correctly set up. Reload it from the current GDT.

Signed-off-by: Joerg Roedel <jroedel@suse.de>
Signed-off-by: Borislav Petkov <bp@suse.de>
Link: https://lkml.kernel.org/r/20210312123824.306-4-joro@8bytes.org
---
 arch/x86/boot/compressed/head_64.S |    9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

--- a/arch/x86/boot/compressed/head_64.S
+++ b/arch/x86/boot/compressed/head_64.S
@@ -89,9 +89,16 @@ SYM_FUNC_START(startup_32)
 	movl	%eax, %gs
 	movl	%eax, %ss
 
-/* setup a stack and make sure cpu supports long mode. */
+	/* Setup a stack and load CS from current GDT */
 	leal	boot_stack_end(%ebp), %esp
 
+	pushl	$__KERNEL32_CS
+	leal	1f(%ebp), %eax
+	pushl	%eax
+	lretl
+1:
+
+	/* Make sure cpu supports long mode. */
 	call	verify_cpu
 	testl	%eax, %eax
 	jnz	no_longmode
