From: Ben Skeggs <bskeggs@redhat.com>
Date: Tue, 8 May 2018 20:39:46 +1000
Subject: drm/nouveau/gr/gf100-: virtualise r419f78 + apply fixes from traces
Git-commit: aa5e38dc9fdf0a11724561777d712bfdf0d6ad99
Patch-mainline: v4.18-rc1
References: FATE#326289 FATE#326079 FATE#326049 FATE#322398 FATE#326166

Removed from GK110[B]/GK208 as RM traces show it not being touched.

Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
Acked-by: Petr Tesarik <ptesarik@suse.com>
---
 drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgf100.c |    2 ++
 drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgf100.h |    1 +
 drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgk104.c |   10 ++++++++--
 3 files changed, 11 insertions(+), 2 deletions(-)

--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgf100.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgf100.c
@@ -1366,6 +1366,8 @@ gf100_grctx_generate_floorsweep(struct g
 		func->r406500(gr);
 	if (func->gpc_tpc_nr)
 		func->gpc_tpc_nr(gr);
+	if (func->r419f78)
+		func->r419f78(gr);
 }
 
 void
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgf100.h
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgf100.h
@@ -59,6 +59,7 @@ struct gf100_grctx_func {
 	void (*dist_skip_table)(struct gf100_gr *);
 	void (*r406500)(struct gf100_gr *);
 	void (*gpc_tpc_nr)(struct gf100_gr *);
+	void (*r419f78)(struct gf100_gr *);
 };
 
 extern const struct gf100_grctx_func gf100_grctx;
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgk104.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgk104.c
@@ -892,6 +892,13 @@ gk104_grctx_generate_unkn(struct gf100_g
 	nvkm_mask(device, 0x419c00, 0x00000008, 0x00000008);
 }
 
+static void
+gk104_grctx_generate_r419f78(struct gf100_gr *gr)
+{
+	struct nvkm_device *device = gr->base.engine.subdev.device;
+	nvkm_mask(device, 0x419f78, 0x00000001, 0x00000000);
+}
+
 void
 gk104_grctx_generate_gpc_tpc_nr(struct gf100_gr *gr)
 {
@@ -923,8 +930,6 @@ gk104_grctx_generate_main(struct gf100_g
 
 	gf100_grctx_generate_floorsweep(gr);
 
-	nvkm_mask(device, 0x419f78, 0x00000001, 0x00000000);
-
 	gf100_gr_icmd(gr, grctx->icmd);
 	nvkm_wr32(device, 0x404154, idle_timeout);
 	gf100_gr_mthd(gr, grctx->mthd);
@@ -1010,4 +1015,5 @@ gk104_grctx = {
 	.alpha_beta_tables = gk104_grctx_generate_alpha_beta_tables,
 	.dist_skip_table = gf117_grctx_generate_dist_skip_table,
 	.gpc_tpc_nr = gk104_grctx_generate_gpc_tpc_nr,
+	.r419f78 = gk104_grctx_generate_r419f78,
 };
