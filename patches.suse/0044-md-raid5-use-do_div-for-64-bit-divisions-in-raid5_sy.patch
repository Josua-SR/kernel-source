From 83c3e5e17b5e3057ac304383a46e3c485d00ffed Mon Sep 17 00:00:00 2001
From: Yufen Yu <yuyufen@huawei.com>
Date: Wed, 22 Jul 2020 23:29:05 -0400
Subject: [PATCH] md/raid5: use do_div() for 64 bit divisions in
 raid5_sync_request
Git-commit: 83c3e5e17b5e3057ac304383a46e3c485d00ffed
Patch-mainline: v5.9-rc1
References: jsc#SLE-13984

We get compilation error on 32-bit architectures (e.g. m68k), as:

  ERROR: modpost: "__udivdi3" [drivers/md/raid456.ko] undefined!

Since 'sync_blocks' is defined as u64, use do_div() to fix this error.

Fixes: c911c46c017c ("md/raid456: convert macro STRIPE_* to RAID5_STRIPE_*")
Signed-off-by: Yufen Yu <yuyufen@huawei.com>
Signed-off-by: Song Liu <songliubraving@fb.com>
Signed-off-by: Coly Li <colyli@suse.de>

---
 drivers/md/raid5.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/md/raid5.c b/drivers/md/raid5.c
index 40961dd1777b..a6ff6e1e039b 100644
--- a/drivers/md/raid5.c
+++ b/drivers/md/raid5.c
@@ -6104,7 +6104,7 @@ static inline sector_t raid5_sync_request(struct mddev *mddev, sector_t sector_n
 	    !md_bitmap_start_sync(mddev->bitmap, sector_nr, &sync_blocks, 1) &&
 	    sync_blocks >= RAID5_STRIPE_SECTORS(conf)) {
 		/* we can skip this block, and probably more */
-		sync_blocks /= RAID5_STRIPE_SECTORS(conf);
+		do_div(sync_blocks, RAID5_STRIPE_SECTORS(conf));
 		*skipped = 1;
 		/* keep things rounded to whole stripes */
 		return sync_blocks * RAID5_STRIPE_SECTORS(conf);
-- 
2.26.2

