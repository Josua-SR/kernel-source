From: Heinrich Schuchardt <xypron.glpk@gmx.de>
Date: Sun, 16 Feb 2020 19:40:50 +0100
Subject: efi/libstub: Simplify efi_get_memory_map()
Patch-mainline: v5.7-rc1
Git-commit: e7ea37b00da43e8f1154b35ef7f1e3aff45981d3
References: jsc#SLE-16407

Do not check the value of status twice.

Signed-off-by: Heinrich Schuchardt <xypron.glpk@gmx.de>
Link: https://lore.kernel.org/r/20200216184050.3100-1-xypron.glpk@gmx.de
Signed-off-by: Ard Biesheuvel <ardb@kernel.org>
Acked-by: Lee, Chun-Yi <jlee@suse.com>
---
 drivers/firmware/efi/libstub/mem.c |   13 +++++++------
 1 file changed, 7 insertions(+), 6 deletions(-)

--- a/drivers/firmware/efi/libstub/mem.c
+++ b/drivers/firmware/efi/libstub/mem.c
@@ -52,13 +52,14 @@ again:
 		goto again;
 	}
 
-	if (status != EFI_SUCCESS)
+	if (status == EFI_SUCCESS) {
+		if (map->key_ptr)
+			*map->key_ptr = key;
+		if (map->desc_ver)
+			*map->desc_ver = desc_version;
+	} else {
 		efi_bs_call(free_pool, m);
-
-	if (map->key_ptr && status == EFI_SUCCESS)
-		*map->key_ptr = key;
-	if (map->desc_ver && status == EFI_SUCCESS)
-		*map->desc_ver = desc_version;
+	}
 
 fail:
 	*map->map = m;
