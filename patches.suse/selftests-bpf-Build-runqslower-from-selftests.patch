From: Andrii Nakryiko <andriin@fb.com>
Date: Sun, 12 Jan 2020 23:31:43 -0800
Subject: selftests/bpf: Build runqslower from selftests
Patch-mainline: v5.6-rc1
Git-commit: 3a0d3092a4edbbcd62360c44a931c8feaf4b4ff1
References: bsc#1177028

Ensure runqslower tool is built as part of selftests to prevent it from bit
rotting.

Signed-off-by: Andrii Nakryiko <andriin@fb.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Link: https://lore.kernel.org/bpf/20200113073143.1779940-7-andriin@fb.com
Acked-by: Gary Lin <glin@suse.com>
---
 tools/bpf/runqslower/Makefile        |    2 +-
 tools/testing/selftests/bpf/Makefile |    7 ++++++-
 2 files changed, 7 insertions(+), 2 deletions(-)

--- a/tools/bpf/runqslower/Makefile
+++ b/tools/bpf/runqslower/Makefile
@@ -10,7 +10,7 @@ CFLAGS := -g -Wall
 
 # Try to detect best kernel BTF source
 KERNEL_REL := $(shell uname -r)
-ifneq ("$(wildcard /sys/kenerl/btf/vmlinux)","")
+ifneq ("$(wildcard /sys/kernel/btf/vmlinux)","")
 VMLINUX_BTF := /sys/kernel/btf/vmlinux
 else ifneq ("$(wildcard /boot/vmlinux-$(KERNEL_REL))","")
 VMLINUX_BTF := /boot/vmlinux-$(KERNEL_REL)
--- a/tools/testing/selftests/bpf/Makefile
+++ b/tools/testing/selftests/bpf/Makefile
@@ -73,7 +73,7 @@ TEST_PROGS_EXTENDED := with_addr.sh \
 # Compile but not part of 'make run_tests'
 TEST_GEN_PROGS_EXTENDED = test_sock_addr test_skb_cgroup_id_user \
 	flow_dissector_load test_flow_dissector test_tcp_check_syncookie_user \
-	test_lirc_mode2_user xdping test_cpp
+	test_lirc_mode2_user xdping test_cpp runqslower
 
 TEST_CUSTOM_PROGS = urandom_read
 
@@ -124,6 +124,11 @@ $(OUTPUT)/test_stub.o: test_stub.c
 	$(call msg,CC,,$@)
 	$(CC) -c $(CFLAGS) -o $@ $<
 
+.PHONY: $(OUTPUT)/runqslower
+$(OUTPUT)/runqslower: force
+	$(Q)$(MAKE) $(submake_extras) -C $(TOOLSDIR)/bpf/runqslower	      \
+		    OUTPUT=$(CURDIR)/tools/
+
 BPFOBJ := $(OUTPUT)/libbpf.a
 
 $(TEST_GEN_PROGS) $(TEST_GEN_PROGS_EXTENDED): $(OUTPUT)/test_stub.o $(BPFOBJ)
