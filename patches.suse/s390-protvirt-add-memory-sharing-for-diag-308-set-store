From: Vasily Gorbik <gor@linux.ibm.com>
Date: Mon, 1 Apr 2019 19:11:04 +0200
Subject: s390/protvirt: add memory sharing for diag 308 set/store
Git-commit: db9492cef45efc347beed7b617dfdfac399f662b
Patch-mainline: v5.2-rc1
References: jsc#SLE-5759 FATE#327003 bsc#1135153 LTC#173151

Add sharing of ipl parameter block for diag 308 set/store calls to allow
kvm access in protected virtualization environment.

Signed-off-by: Vasily Gorbik <gor@linux.ibm.com>
Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
Acked-by: Petr Tesarik <ptesarik@suse.com>

[ ptesarik: Added SLE modifications by IBM's Vasily Gorbik, because
  SLE15-SP1 does not contain these upstream commits:
  96c0cdbc7c60885d65dc8d11a39bbcfd9cc49d03
  49698745e53c417370ac5cfe8b849bb65d62f129  ]

---
 arch/s390/kernel/ipl.c |   11 +++++++++++
 1 file changed, 11 insertions(+)

--- a/arch/s390/kernel/ipl.c
+++ b/arch/s390/kernel/ipl.c
@@ -30,6 +30,7 @@
 #include <asm/checksum.h>
 #include <asm/debug.h>
 #include <asm/os_info.h>
+#include <asm/uv.h>
 #include "entry.h"
 
 #define IPL_PARM_BLOCK_VERSION 0
@@ -1087,11 +1088,15 @@ static void __reipl_run(void *unused)
 		__cpcmd(buf, NULL, 0, NULL);
 		break;
 	case REIPL_METHOD_CCW_DIAG:
+		uv_set_shared(__pa(reipl_block_ccw));
 		diag308(DIAG308_SET, reipl_block_ccw);
+		uv_remove_shared(__pa(reipl_block_ccw));
 		diag308(DIAG308_LOAD_CLEAR, NULL);
 		break;
 	case REIPL_METHOD_FCP_RW_DIAG:
+		uv_set_shared(__pa(reipl_block_fcp));
 		diag308(DIAG308_SET, reipl_block_fcp);
+		uv_remove_shared(__pa(reipl_block_fcp));
 		diag308(DIAG308_LOAD_CLEAR, NULL);
 		break;
 	case REIPL_METHOD_FCP_RO_DIAG:
@@ -1101,7 +1106,9 @@ static void __reipl_run(void *unused)
 		__cpcmd("IPL", NULL, 0, NULL);
 		break;
 	case REIPL_METHOD_NSS_DIAG:
+		uv_set_shared(__pa(reipl_block_nss));
 		diag308(DIAG308_SET, reipl_block_nss);
+		uv_remove_shared(__pa(reipl_block_nss));
 		diag308(DIAG308_LOAD_CLEAR, NULL);
 		break;
 	case REIPL_METHOD_NSS:
@@ -1424,7 +1431,9 @@ static struct kset *dump_kset;
 
 static void diag308_dump(void *dump_block)
 {
+	uv_set_shared(__pa(dump_block));
 	diag308(DIAG308_SET, dump_block);
+	uv_remove_shared(__pa(dump_block));
 	while (1) {
 		if (diag308(DIAG308_LOAD_NORMAL_DUMP, NULL) != 0x302)
 			break;
@@ -1987,7 +1996,9 @@ void __init ipl_update_parameters(void)
 {
 	int rc;
 
+	uv_set_shared(__pa(&ipl_block));
 	rc = diag308(DIAG308_STORE, &ipl_block);
+	uv_remove_shared(__pa(&ipl_block));
 	if ((rc == DIAG308_RC_OK) || (rc == DIAG308_RC_NOCONFIG))
 		diag308_set_works = 1;
 }
