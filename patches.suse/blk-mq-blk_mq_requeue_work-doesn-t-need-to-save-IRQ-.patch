From: Jens Axboe <axboe@kernel.dk>
Date: Thu, 27 Jul 2017 08:03:57 -0600
Subject: [PATCH] blk-mq: blk_mq_requeue_work() doesn't need to save IRQ flags
Git-commit: 18e9781d44000bcb403941011d954896df7439cc
Patch-Mainline: v4.14-rc1
References: bsc#1104967,FATE#325924

We know we're in process context, so don't bother using the
IRQ safe versions of the spin lock.

Signed-off-by: Jens Axboe <axboe@kernel.dk>
Acked-by: Hannes Reinecke <hare@suse.com>
---
 block/blk-mq.c | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/block/blk-mq.c b/block/blk-mq.c
index 041f7b7fa0d6..b70a4ad78b63 100644
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@ -620,11 +620,10 @@ static void blk_mq_requeue_work(struct work_struct *work)
 		container_of(work, struct request_queue, requeue_work.work);
 	LIST_HEAD(rq_list);
 	struct request *rq, *next;
-	unsigned long flags;
 
-	spin_lock_irqsave(&q->requeue_lock, flags);
+	spin_lock_irq(&q->requeue_lock);
 	list_splice_init(&q->requeue_list, &rq_list);
-	spin_unlock_irqrestore(&q->requeue_lock, flags);
+	spin_unlock_irq(&q->requeue_lock);
 
 	list_for_each_entry_safe(rq, next, &rq_list, queuelist) {
 		if (!(rq->rq_flags & RQF_SOFTBARRIER))
-- 
2.16.4

