From: David Ahern <dsahern@kernel.org>
Date: Mon, 8 Jun 2020 09:17:23 -0600
Subject: bpf: Reset data_meta before running programs attached to devmap entry
Patch-mainline: v5.8-rc1
Git-commit: 26afa0a4eb3fd87757f9de56ec5db5a03b14e120
References: bsc#1177028

This is a new context that does not handle metadata at the moment, so
mark data_meta invalid.

Fixes: fbee97feed9b ("bpf: Add support to attach bpf program to a devmap entry")
Signed-off-by: David Ahern <dsahern@kernel.org>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Link: https://lore.kernel.org/bpf/20200608151723.9539-1-dsahern@kernel.org
Acked-by: Gary Lin <glin@suse.com>
---
 kernel/bpf/devmap.c |    1 +
 1 file changed, 1 insertion(+)

--- a/kernel/bpf/devmap.c
+++ b/kernel/bpf/devmap.c
@@ -479,6 +479,7 @@ static struct xdp_buff *dev_map_run_prog
 	struct xdp_txq_info txq = { .dev = dev };
 	u32 act;
 
+	xdp_set_data_meta_invalid(xdp);
 	xdp->txq = &txq;
 
 	act = bpf_prog_run_xdp(xdp_prog, xdp);
