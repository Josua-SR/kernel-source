From: Stefan Raspl <raspl@linux.ibm.com>
Subject: net/smc: use announced length in sock_recvmsg()
Patch-mainline: v4.16
Git-commit: ab6f6dd18ab801fcbbaa05fb5401e91f48778e04
References: FATE#325694, LTC#167874, bsc#1113480

Summary:     net/smc: SMC-R MVP
Description: Add latest upstream patches to push SMC-R to the MVP level

Upstream-Description:

             net/smc: use announced length in sock_recvmsg()

             Not every CLC proposal message needs the maximum buffer length.
             Due to the MSG_WAITALL flag, it is important to use the peeked
             real length when receiving the message.

             Fixes: d63d271ce2b5ce ("smc: switch to sock_recvmsg()")
             Signed-off-by: Ursula Braun <ubraun@linux.vnet.ibm.com>
             Signed-off-by: David S. Miller <davem@davemloft.net>

Signed-off-by: Stefan Raspl <raspl@linux.ibm.com>
Acked-by: Petr Tesarik <ptesarik@suse.com>
---
 net/smc/smc_clc.c |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- a/net/smc/smc_clc.c
+++ b/net/smc/smc_clc.c
@@ -132,7 +132,7 @@ int smc_clc_wait_msg(struct smc_sock *sm
 
 	/* receive the complete CLC message */
 	memset(&msg, 0, sizeof(struct msghdr));
-	iov_iter_kvec(&msg.msg_iter, READ | ITER_KVEC, &vec, 1, buflen);
+	iov_iter_kvec(&msg.msg_iter, READ | ITER_KVEC, &vec, 1, datlen);
 	krflags = MSG_WAITALL;
 	smc->clcsock->sk->sk_rcvtimeo = CLC_WAIT_TIME;
 	len = sock_recvmsg(smc->clcsock, &msg, krflags);
