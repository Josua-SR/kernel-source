From: Vitaly Prosyak <vitaly.prosyak@amd.com>
Date: Thu, 23 Nov 2017 09:42:22 -0600
Subject: drm/amd/display: Move unity TF type to predefined types
Git-commit: 79086a55defa83c0735c5a3ee30e573f5076eb66
Patch-mainline: v4.16-rc1
References: FATE#326289 FATE#326079 FATE#326049 FATE#322398 FATE#326166

Also handle fixpoint y values for CM curves

Signed-off-by: Vitaly Prosyak <vitaly.prosyak@amd.com>
Reviewed-by: Tony Cheng <Tony.Cheng@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Acked-by: Petr Tesarik <ptesarik@suse.com>
---
 drivers/gpu/drm/amd/display/dc/dc.h                    |    2 +-
 drivers/gpu/drm/amd/display/dc/dcn10/dcn10_cm_common.c |    6 ++++--
 drivers/gpu/drm/amd/display/dc/dcn10/dcn10_dpp.h       |    3 +--
 3 files changed, 6 insertions(+), 5 deletions(-)

--- a/drivers/gpu/drm/amd/display/dc/dc.h
+++ b/drivers/gpu/drm/amd/display/dc/dc.h
@@ -343,7 +343,6 @@ enum dc_transfer_func_type {
 	TF_TYPE_PREDEFINED,
 	TF_TYPE_DISTRIBUTED_POINTS,
 	TF_TYPE_BYPASS,
-	TF_TYPE_UNITY
 };
 
 struct dc_transfer_func_distributed_points {
@@ -362,6 +361,7 @@ enum dc_transfer_func_predefined {
 	TRANSFER_FUNCTION_BT709,
 	TRANSFER_FUNCTION_PQ,
 	TRANSFER_FUNCTION_LINEAR,
+	TRANSFER_FUNCTION_UNITY,
 };
 
 struct dc_transfer_func {
--- a/drivers/gpu/drm/amd/display/dc/dcn10/dcn10_cm_common.c
+++ b/drivers/gpu/drm/amd/display/dc/dcn10/dcn10_cm_common.c
@@ -168,8 +168,10 @@ bool cm_helper_convert_to_custom_float(
 		return false;
 	}
 
-	if (!convert_to_custom_float_format(arr_points[1].y, &fmt,
-					    &arr_points[1].custom_float_y)) {
+	if (fixpoint == true)
+		arr_points[1].custom_float_y = dal_fixed31_32_u0d14(arr_points[1].y);
+	else if (!convert_to_custom_float_format(arr_points[1].y, &fmt,
+		&arr_points[1].custom_float_y)) {
 		BREAK_TO_DEBUGGER();
 		return false;
 	}
--- a/drivers/gpu/drm/amd/display/dc/dcn10/dcn10_dpp.h
+++ b/drivers/gpu/drm/amd/display/dc/dcn10/dcn10_dpp.h
@@ -731,7 +731,7 @@
 	type CM_BLNDGAM_LUT_WRITE_EN_MASK; \
 	type CM_BLNDGAM_LUT_WRITE_SEL; \
 	type CM_BLNDGAM_LUT_INDEX; \
-	type CM_BLNDGAM_LUT_DATA; \
+	type BLNDGAM_MEM_PWR_FORCE; \
 	type CM_3DLUT_MODE; \
 	type CM_3DLUT_SIZE; \
 	type CM_3DLUT_INDEX; \
@@ -1147,7 +1147,6 @@ struct dcn_dpp_mask {
 	uint32_t CM_BLNDGAM_RAMA_REGION_30_31; \
 	uint32_t CM_BLNDGAM_RAMA_REGION_32_33; \
 	uint32_t CM_BLNDGAM_LUT_INDEX; \
-	uint32_t CM_BLNDGAM_LUT_DATA; \
 	uint32_t CM_3DLUT_MODE; \
 	uint32_t CM_3DLUT_INDEX; \
 	uint32_t CM_3DLUT_DATA; \
