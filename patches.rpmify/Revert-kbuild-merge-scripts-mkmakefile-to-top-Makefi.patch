From f186c7daf67846335a128ca10a87e07adaa25274 Mon Sep 17 00:00:00 2001
From: Michal Suchanek <msuchanek@suse.de>
Date: Thu, 27 May 2021 17:46:44 +0200
Subject: [PATCH] Revert "kbuild: merge scripts/mkmakefile to top Makefile"

References: ../scripts/mkmakefile: No such file or directory
Patch-mainline: submitted https://lore.kernel.org/linux-kbuild/20210526202825.GB8544@kitsune.suse.cz/T/#t

This reverts commit 2728fcfa4fcc0c4152629c48d49c3bd5f9008329.

When packaging the kernel it is built in different place from the one in
which it will be installed. After build the makefile needs to be
regenerated with the target location but with mkmakefile merged into
Makefile tehre is no way to do that.

Signed-off-by: Michal Suchanek <msuchanek@suse.de>
---
 Makefile           | 11 ++---------
 scripts/mkmakefile | 17 +++++++++++++++++
 2 files changed, 19 insertions(+), 9 deletions(-)
 create mode 100755 scripts/mkmakefile

diff --git a/Makefile b/Makefile
index b0619adfcc58..462899c1b5d7 100644
--- a/Makefile
+++ b/Makefile
@@ -573,21 +573,14 @@ scripts_basic:
 	$(Q)rm -f .tmp_quiet_recordmcount
 
 PHONY += outputmakefile
-ifdef building_out_of_srctree
 # Before starting out-of-tree build, make sure the source tree is clean.
 # outputmakefile generates a Makefile in the output directory, if using a
 # separate output directory. This allows convenient use of make in the
 # output directory.
 # At the same time when output Makefile generated, generate .gitignore to
 # ignore whole output directory
-
-quiet_cmd_makefile = GEN     Makefile
-      cmd_makefile = { \
-	echo "\# Automatically generated by $(srctree)/Makefile: don't edit"; \
-	echo "include $(srctree)/Makefile"; \
-	} > Makefile
-
 outputmakefile:
+ifdef building_out_of_srctree
 	$(Q)if [ -f $(srctree)/.config -o \
 		 -d $(srctree)/include/config -o \
 		 -d $(srctree)/arch/$(SRCARCH)/include/generated ]; then \
@@ -598,7 +591,7 @@ outputmakefile:
 		false; \
 	fi
 	$(Q)ln -fsn $(srctree) source
-	$(call cmd,makefile)
+	$(Q)$(CONFIG_SHELL) $(srctree)/scripts/mkmakefile $(srctree)
 	$(Q)test -e .gitignore || \
 	{ echo "# this is build directory, ignore it"; echo "*"; } > .gitignore
 endif
diff --git a/scripts/mkmakefile b/scripts/mkmakefile
new file mode 100755
index 000000000000..1cb174751429
--- /dev/null
+++ b/scripts/mkmakefile
@@ -0,0 +1,17 @@
+#!/bin/sh
+# SPDX-License-Identifier: GPL-2.0
+# Generates a small Makefile used in the root of the output
+# directory, to allow make to be started from there.
+# The Makefile also allow for more convinient build of external modules
+
+# Usage
+# $1 - Kernel src directory
+
+if [ "${quiet}" != "silent_" ]; then
+	echo "  GEN     Makefile"
+fi
+
+cat << EOF > Makefile
+# Automatically generated by $0: don't edit
+include $1/Makefile
+EOF
-- 
2.26.2

